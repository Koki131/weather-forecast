<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="ISO-8859-1">
<title>Forecast</title>

<!-- Bootstrap -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

<!-- JQuery -->
<script src="https://code.jquery.com/jquery-3.6.3.js" integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM=" crossorigin="anonymous"></script>

<!-- Animation -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css">

<!-- CSS -->
<link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
	
	<nav id="nav" class="navbar fixed-top animated fadeInUp">
  		<div class="container-fluid">
  			<div class="nav-box element-flex">
		    	<a  th:href="@{/}" style="color: white;">Weather app</a>
		    </div>
  		</div>
	</nav>	

	
	<section class="vh-100 mw-100 animated fadeInUp">
	  <div class="container py-5 vh-100">
	
	    <div class="row d-flex justify-content-center align-items-center h-100">
	      <div class="content-container">
	
	        <div class="card" style="border-radius: 35px;" id="card">
	          <div class="card-body p-4">
	
	            <div class="d-flex">
	              <h6 class="flex-grow-1">[[${weatherData.name}]], [[${weatherData.sys.country}]]</h6>
	          		<div class="d-flex flex-column text-center  mb-4">
	          			<h6 id="sunrise"></h6>
	          			<h6 id="sunset"></h6>
	          		</div>
	            </div>
				
		            <div class="d-flex flex-column text-center">
		               <div>
			             <img id="weather-icon" src="" width="100px">
			           </div>
		            	<div class="d-flex justify-content-center align-items-center">
						  <div class="flex-column mr mt-2">
						    <h6 id="min-temp">Min [[${weatherData.main.temp_min}]] &#8451;</h6>
						    <h6 id="max-temp">Max [[${weatherData.main.temp_max}]] &#8451;</h6>
						  </div>
						  	<h6 id="temp" class="display-2 font-weight-bold" style="color: #1C2331;"> [[${weatherData.main.temp}]] </h6>
						  	<div class="flex-column-links ml">
							    <a id="toCelsius" href="#" class="display-6 font-weight-bold">&#8451;</a>
							    <a id="toFarenheit" href="#" class="display-6 font-weight-bold">&#8457;</a>
						   </div>
						</div>
		              		<span class="small" style="color: #868B94">[[${weatherData.weather[0].main}]] - [[${weatherData.weather[0].description}]]</span>
		              	 <div class="d-flex align-items-center">
					       <div class="flex-grow-1" style="font-size: 1rem;">
						         <div class="d-flex justify-content-center align-items-center mt-2">
								  	<div class="flex-column mr">
								  		<div class="flex-column mb-2">
								    		<i class="fas fa-sun fa-fw mr-2" style="color: #868B94;"></i> <span id="feels_like" class="ms-1"> Feels like [[${weatherData.main.feels_like}]] &#8451;</span>
								    		<i class="fas fa-wind fa-fw ml-2" style="color: #868B94;"></i> <span id="wind" class="ms-1 "> Wind speed [[${weatherData.wind.speed}]] km/h</span>
								    	</div>
								        <div class="flex-column">
								    		<i class="fas fa-tint fa-fw mr-2" style="color: #868B94;"></i> <span class="ms-1"> Humidity [[${weatherData.main.humidity}]] % </span>
								    		<i class="fas fa-sun fa-fw ml-2" style="color: #868B94;"></i> <span class="ms-1"> Pressure [[${weatherData.main.pressure}]] hPa </span>
								       </div>
								       <div class="flex-column">
								    		<i class="fas fa-tint fa-fw mr-2" style="color: #868B94;"></i> <div id="aqhi"> AQHI <span id="aqhi-value" class="ml-2"> [[${airQuality.list[0].main.aqi}]]</span></div>
								       </div> 
								    </div>       	   
						        </div>
		           			</div>
		            	 </div>
						 <hr>
		            	 <div class="wrapper">
							  <ul th:each="days : ${forecast.keySet()}">
							    <li style="display: inline;">
							      <div class="forecast ">
							      
							      		<div class="flex-column">
								    		<i class="fas fa-tint fa-fw" style="color: #868B94;"></i> <span class="ms-1" style="font-size: 13px;" th:text="${forecast.get(days).get(0).getDt_txt().substring(0, 3)}">  </span>
								    		<i class="fas fa-sun fa-fw" style="color: #868B94;"></i> <span class="ms-1" id="day" style="font-size: 13px;" th:text="${days}">  </span>
								       </div>
								       
								       <img  alt="" 
							        	th:src="@{'http://openweathermap.org/img/wn/' + ${forecast.get(days).get(0).getWeather().get(0).getIcon().substring(0, 2)} + 'd@2x.png'}"/>
							        	
							        	<div class="flex-column ">
								        	<i class="fas fa-sun fa-fw" style="color: #868B94; "></i> <span id="dailyMax" class="ms-1" style="font-size: 20px;" 
								        				th:text="${minMax.get(days).getMaxTemp()} + ' ' +  &#8451;">  </span>
								        	
								    		<i class="fas fa-tint fa-fw" style="color: #868B94;"></i> <span id="dailyMin" class="ms-1" style="font-size: 13px;"
								    		 th:text="${minMax.get(days).getMinTemp()} + ' ' +  &#8451;">  </span>
								       </div>
								       
								       <p style="font-size: 13px;" th:text="${forecast.get(days).get(0).getWeather().get(0).getMain()}"></p>
								       
							      </div>
							    </li>
							  </ul>
						</div>
						<hr>
						<div id="display-div"></div>
		          	  </div>
		       	  </div>
	      	  </div>
	       </div>
		</div>
	  </div>
	</section>

	<script th:inline="javascript">
	
		const forecast = [[${forecast}]];
		
		let isCelsius = true;
		
		
		
		
		const links = document.querySelectorAll('.forecast');
	  	links.forEach(function(link, index) {
	  		
	   		link.addEventListener('click', function(event) {
	   			
			      event.preventDefault();
			      
			      links.forEach(function(link) {
			          link.classList.remove('active');
			      });
			      
			      
			      this.classList.add('active');
			      
			      const dayValue = this.querySelector('#day').textContent;
			      
			      const dayValueInt = parseInt(dayValue, 10);
			      
			      const values = forecast[dayValueInt];

			      // Get the display div
			      const displayDiv = document.querySelector("#display-div");

			      // Clear its contents
			      displayDiv.innerHTML = "";
					
			      // Iterate over the values and add them to the display div
			      for (var i = 0; i < values.length; i++) {
			    	  
			        const value = values[i];
			        

			        const valueDiv = document.createElement("div");
			        valueDiv.classList.add("value-div");
			        valueDiv.classList.add("animated");
			        valueDiv.classList.add("fadeIn");
			        
			        const img = document.createElement("img");
			        img.src = "http://openweathermap.org/img/wn/" + value.weather[0].icon + "@2x.png";
			        img.alt = "weather icon";
			        img.id = "hourly-icon"

			        const weather = document.createElement("p");
			        weather.innerText = value.weather[0].main;
			        weather.id = "hourly-weather";
			        
			        
			        const temp = document.createElement("p");
			        temp.id = "hourly-temp";
			       	
			       
			        const time = document.createElement("p");
			        time.id = "time";
			        
			        const timeValue = value.dt_txt.substring(3, value.dt_txt.length);
			        
			       	time.innerText = timeValue;
			        
			       	const hourMinutes = parseInt(time.textContent, 10);
			        
			       	if (hourMinutes <= 9) {
			       		time.innerText = '0' + timeValue + '0';
			       	} else {
			       		time.innerText = timeValue + '0';
			       	}
			       	
			       	
			        if (isCelsius) {
			        	temp.innerText = value.main.temp + ' \u00B0C';
			        	
			        } else {
			        	temp.innerText =  Math.round((value.main.temp * 1.8) + 32) + ' \u00B0F';
			        }
			        
			        displayDiv.appendChild(valueDiv);
			        valueDiv.appendChild(time);
			        valueDiv.appendChild(img);
			        valueDiv.appendChild(temp);
			        valueDiv.appendChild(weather);
			         
			      }
			      
	    	});
	   		
	   		if (index === 0) {
	   		    link.click();
	   		}
	   		
	  	});
	  	
	  	
	
	
		$(document).ready(function() {
				$("#toCelsius").addClass("active");
				$("#toCelsius, #toFarenheit").click(function(event) {
					event.preventDefault();
					$("#toCelsius, #toFarenheit").removeClass("active");
					$(this).addClass("active");
			});
		});
		
		
		document.querySelector("#weather-icon").src = "http://openweathermap.org/img/wn/" + [[${weatherData.weather[0].icon}]] + "@2x.png";
		
		
		
		const sunrise = new Date([[${weatherData.sys.sunrise}]] * 1000);
		const sunset = new Date([[${weatherData.sys.sunset}]] * 1000);
		
		const sunriseHours = sunrise.getHours();
		const sunriseMinutes = sunrise.getMinutes();
		
		const sunsetHours = sunset.getHours();
		const sunsetMinutes = sunset.getMinutes();
		
		document.querySelector("#sunrise").innerHTML = "Sunrise " + sunriseHours + " : " + sunriseMinutes;
		document.querySelector("#sunset").innerHTML = "Sunset " + sunsetHours + " : " + sunsetMinutes;
		
		
		
		
		const currentHour = [[${date.getHours()}]];
		
		if (currentHour <= sunriseHours || currentHour >= sunsetHours) {
			document.body.style.backgroundImage = "url('/images/background/" +  [[${weatherData.weather[0].main}]] + "_night.png"; 

		} else {
			document.body.style.backgroundImage = "url('/images/background/" +  [[${weatherData.weather[0].main}]] + ".png"; 
		}
		
		
		
		
			
		const temperatureData = {
			celsius: {
				min: [[${weatherData.main.temp_min}]],
			    max: [[${weatherData.main.temp_max}]],
			    temp: [[${weatherData.main.temp}]],
		        feels_like: [[${weatherData.main.feels_like}]],
		        wind_speed: [[${weatherData.wind.speed}]],
		        wind_unit: "km/h"
		    },
		    farenheit: {
	    	    min: [[${weatherImperial.main.temp_min}]],
			    max: [[${weatherImperial.main.temp_max}]],
			    temp: [[${weatherImperial.main.temp}]],
		        feels_like: [[${weatherImperial.main.feels_like}]],
		        wind_speed: [[${weatherImperial.wind.speed}]],
		        wind_unit: "mph"
		    }
		};

		const temperatureUnit = {
			celsius: "&#8451;",
			farenheit: "&#8457;"
		};

		function updateTemperature(unit) {
		    const {
		      	  min,
		     	  max,
			      temp,
			      feels_like,
			      wind_speed,
			      wind_unit
		    } = temperatureData[unit];

			document.querySelector("#min-temp").innerHTML = `Min ${min} ${temperatureUnit[unit]}`;
		    document.querySelector("#max-temp").innerHTML = `Max ${max} ${temperatureUnit[unit]}`;
		    document.querySelector("#temp").innerHTML = `${temp}`;
		    document.querySelector("#feels_like").innerHTML = `Feels like ${feels_like} ${temperatureUnit[unit]}`;
		    document.querySelector("#wind").innerHTML = `Wind speed ${wind_speed} ${wind_unit}`;

		    
		}

		
		document.querySelector("#toCelsius").addEventListener("click", function() {
			
			
			if (!isCelsius) {
				document.querySelectorAll(".forecast").forEach(forecast => {
					
					  const dailyMax = parseInt(forecast.querySelector("#dailyMax").textContent.split(" ")[0], 10);			  
					  const dailyMin = parseInt(forecast.querySelector("#dailyMin").textContent.split(" ")[0], 10);	
					   
					  forecast.querySelector('#dailyMax').innerHTML = Math.round((dailyMax - 32) * 0.5556) + ' ' + '&#8451;';
					  forecast.querySelector('#dailyMin').innerHTML = Math.round((dailyMin - 32) * 0.5556) + ' ' + '&#8451;';

				});
				

	 			
				const displayDiv = document.querySelector("#display-div");
				
				const valueDivs = displayDiv.querySelectorAll(".value-div");
				
	 			valueDivs.forEach(function(valueDiv) {

	 				const tempInnerText = valueDiv.querySelector('#hourly-temp');
	 				
	 				const temp = parseInt(tempInnerText.textContent, 10);
	 				tempInnerText.innerHTML = Math.round((temp - 32) * 0.5556) + ' \u00B0C';
	 				
	 				
	 				
	 			});
				
				isCelsius = true;
				
			}

		    updateTemperature("celsius");
 	    });

	 	document.querySelector("#toFarenheit").addEventListener("click", function() {
	 		
	 		if (isCelsius) {
	 			document.querySelectorAll(".forecast").forEach(forecast => {
					
					  const dailyMax = parseInt(forecast.querySelector("#dailyMax").textContent.split(" ")[0], 10);			  
					  const dailyMin = parseInt(forecast.querySelector("#dailyMin").textContent.split(" ")[0], 10);						  
  
					  forecast.querySelector('#dailyMax').innerHTML = Math.round((dailyMax * 1.8) + 32) + ' ' + '&#8457;';
					  forecast.querySelector('#dailyMin').innerHTML = Math.round((dailyMin * 1.8) + 32) + ' ' + '&#8457;';

				});
	 			
	 			
	 			const displayDiv = document.querySelector("#display-div");
				
	 			const valueDivs = displayDiv.querySelectorAll(".value-div");
	 			
	 			valueDivs.forEach(function(valueDiv) {
	 				  
	 				const tempInnerText = valueDiv.querySelector('#hourly-temp');
	 				
	 				const temp = parseInt(tempInnerText.textContent, 10);
	 				tempInnerText.innerHTML = Math.round((temp * 1.8) + 32)  + ' \u00B0F';
	 				
	 				
	 				
	 			});
	 			
	 			isCelsius = false;
	 			
	 		}

		    updateTemperature("farenheit");	    
		});
			
	 	
	 	// AIR QUALITY 
	 	
	 	const aqhiValue = document.querySelector("#aqhi-value");
		const aqhi = parseInt(aqhiValue.textContent);
		
		if (aqhi <= 3) {
		  aqhiValue.classList.add("good");
		} else if (aqhi <= 6) {
		  aqhiValue.classList.add("moderate");
		} else {
		  aqhiValue.classList.add("unhealthy");
		}
	 	

	</script>
	
	
</body>
</html>